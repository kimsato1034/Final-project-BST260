---
title: "Final_project_crash"
output: html_document
---

```{r, message = FALSE, warning = FALSE}
library(readr)
library(dplyr)
library(lubridate)
library(ggplot2)
```

We are going to use `crash` data in Boston from Jan 1, 2015 to Sep 30, 2018. 

```{r, message = FALSE}
crash <- read_csv("crash_sept.csv")
```


```{r}
temp <- crash %>%
  mutate(year = year(dispatch_ts), month = month(dispatch_ts, label = TRUE), day = day(dispatch_ts),
         wday = wday(dispatch_ts, label = TRUE), hour = hour(dispatch_ts))
```


#### Creating a new column indicating bike accidents
```{r}
temp <- temp %>%
  mutate(mode_type = as.factor(mode_type)) %>%
  mutate( accid = ifelse(mode_type == "bike", "1","0"))
```


### cross validation to have training, testing and holdout sets 
#```{r}

library(caret)

library(mlbench)
data(temp)

set.seed(1)
 
require(caret)
 
classes <- temp[, "accid"]

predictors <- temp[, -match(c("year", "month", "day", "wday", "hour"), colnames(temp))]
train_set <- createDataPartition(classes, p = 0.8, list = TRUE)  #80 percentage of data goes on training set 
#classes need to have 2 data points 
str(train_set) 
 
train_predictors <- predictors[train_set, ]
train_classes <- classes[train_set]
test_predictors <- predictors[-train_set, ]
test_classes <- classes[-train_set]
 
set.seed(seed)
cv_splits <- createFolds(classes, k = 10, returnTrain = TRUE)
str(cv_splits)


```



#### Supervised Learning : Perform logistic regression 1
```{r}
glm_fit1 <- temp %>% 
  mutate(accid = as.numeric(accid), month = as.factor(month)) %>%
  group_by(wday) %>%
  glm( accid ~ wday, data=., family = "binomial")

factor(temp$wday)
#Levels: Sun < Mon < Tue < Wed < Thu < Fri < Sat

glm_fit1

#wday.L = Sunday 
#wday.Q = Monday 
#wday.C = Tuesday 
#wday^4 = Wednesday 
#wday^5 = Thursday 
#wday^6 = Friday 
#Intercept = Saturday 

```

#### Perform logistic regression 2 

```{r}

glm_fit2 <- temp %>% 
  mutate(accid = as.numeric(accid), month = as.factor(month)) %>%
  group_by(month) %>%
  glm( accid ~ month, data=., family = "binomial")

#By factor(temp$month)
# Levels: Jan < Feb < Mar < Apr < May < Jun < Jul < Aug < Sep < Oct < Nov < Dec

glm_fit2

```

#### make a graph

```{r}

temp %>% 
  mutate(accid = as.numeric(accid), month = as.factor(month)) %>%
  group_by(month) %>%
  summarize(prob = mean(accid))

```

#### Maximum likeliehood estimate

```{r}


```

#### log loss 
```{r}



```

#### Regularization - Lasso 

```{r}



```


#### Regularization - Ridge 

```{r}



```


#### log loss

```{r}



```


#### ROC curve 
```{r}





```





### Total number of crashes in each month from 2015 to 2017
```{r}
temp %>%
  filter(year != 2018) %>%
  mutate(mode_type = as.factor(mode_type)) %>%
  group_by(mode_type) %>%
  ggplot() +
  geom_bar(aes(month))
```

### Number of `bike` crashes by month (2015-2017)
```{r}
temp %>%
  filter(mode_type == "bike" & year != 2018) %>%
  ggplot() +
  geom_histogram(aes(month), stat ="count")
```

```{r}
temp %>%
  filter(mode_type == "bike" & year != 2018) %>%
  ggplot(aes(hour)) +
  geom_density(fill="#0099FF")
```

```{r}
temp %>%
  filter(mode_type == "bike" & year != 2018) %>%
  group_by(month) %>%
  ggplot(aes(hour)) +
  geom_density(fill = "#0099FF") +
  facet_wrap(~ month)
```


```{r}
temp %>%
  filter(mode_type == "bike" & year != 2018) %>%
  group_by(wday) %>%
  ggplot(aes(hour)) +
  geom_density(fill = "#0099FF") +
  facet_wrap(~ wday)
```

```{r}
library(tidyverse)
library(ggmap)
library(mapview)






```

[link]("https://www.boston.com/news/local-news/2014/06/19/cyclists-beware-this-new-map-shows-bike-crash-hotspots-across-boston")


